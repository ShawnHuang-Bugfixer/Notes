# UDP

UDP 是一种无连接的传输层协议，它直接封装应用层数据，不对数据进行拆分与重组，采用尽最大努力交付（best-effort delivery）的方式，不保证数据的可靠性、顺序性和完整性，适用于对时效性要求高、但可容忍一定丢包的实时应用场景（如视频通话、在线游戏、语音通信等）。

一个 UDP 报文就是一个完整的消息（Message-oriented），大小受限于底层网络 MTU（通常最大为 65,535 字节，但实际建议远小于此）。
# TCP

TCP 是一种面向连接的、可靠的、全双工的字节流传输协议。

TCP 是面向连接的协议，提供可靠、有序的全双工通信。发送方和接收方都维护发送缓存和接收缓存。应用层数据被视为有序字节流放入发送缓存，TCP 将其分段后发送，接收方根据序号重组还原。

TCP 请求头如图：

![[attachments/Pasted image 20250517202013.png]]

- 序号：TCP 数据部分第一个字节序。
- 确认号：接收方期待发送放发送的字节序。
- 窗口：端点一方的接收窗口大小，表示该端点最大可以接收的数据量，限制发送方数据。
- 关键控制位：
	- SYN：SYN = 1 同步位，建立 TCP 连接时使用，表明该 TCP 报文位连接相关报文。
	- ACK：ACK = 1 时确认号有效，建立连接后传输数据时必须置为 1，表示传输数据。
	- FIN：FIN = 1 时表示发送方数据发送完毕，要求释放连接。
	
## 连接管理

### 3 次握手建立 TCP 连接

![[attachments/Pasted image 20250517203058.png]]

三次握手保证服务端和客户端收发数据正常、对齐 ISN、避免两次握手带来的混乱。

第一次握手，客户端能发；第二次握手，服务器能收能发，第三次握手：客户端能收。

两次握手建立连接会被**旧 SYN 报文问题**干扰。假设由于网络延迟，一个旧的 **SYN 报文在网络中滞留**。现在旧连接早已关闭，**旧的 SYN 报文突然在网络中被服务器收到了**，服务器可能：建立错误的连接，甚至接收错误数据。三次握手需要客户端**对服务器的 SYN-ACK 进行确认（ACK）** 如果旧 SYN 被服务器收到并回复了 SYN-ACK，客户端此时若无响应（因为已不再通信），服务器**得不到第三次 ACK**，服务器会在超时后关闭这个“孤儿连接”，避免错误建立连接。

三次握手的第三次报文中，`seq` 和 `ack` 不仅表示确认，也同步了双方后续数据流的起始字节序号，建立了一个明确的、有序的、可控的数据传输基础。连接建立后，客户端发送缓存字节序从 `seq = x + 1` 开始，服务端应用数据`seq = y + 1` 开始。

## 可靠传输

TCP 通过在**有序**的字节流缓存上使用**滑动窗口算法**，结合**累计确认**和**超时重传机制**，实现了**可靠的数据传输**。

![[attachments/Pasted image 20250517211412.png]]

## 流量管理

TCP 使用滑动窗口算法进行流量管理，窗口大小为 MIN（接收方窗口，拥塞窗口）。

![[attachments/Pasted image 20250517211952.png]]
## 拥塞控制

TCP 使用拥塞控制主动控制写入到网络中的数据量，避免过多数据写入网络中导致阻塞网络。

TCP 使用 4 中拥塞控制算法控制数据的写入量：

- 慢开始，拥塞避免
- 快重传，快恢复

### 慢开始，拥塞避免

慢开始阶段，拥塞窗口起始大小为 1，每经过 1 个传输轮次（发送数据，收到 ack），拥塞窗口变为原来的两倍（指数增长），当大于等于慢开始阈值时，进入拥塞避免阶段，每个传输轮次拥塞窗口大小 + 1，当出现网络拥塞时，拥塞窗口大小变为 1 ，并把慢开始阈值变为出现网络拥塞时拥塞窗口大小的一半。进入下一次循环。**出现严重丢包**

![[attachments/Pasted image 20250517212838.png]]

### 快重传、快恢复

当发送方接收到 3 次接收方的冗余 ACK，说明发送方某个较小字节序的报文丢失，触发快重传机制。快重传将慢开始阈值变为出现网络拥塞时拥塞窗口大小的一半，直接进入拥塞避免阶段（快恢复）。**判定为轻度拥塞**

![[attachments/Pasted image 20250517213823.png]]