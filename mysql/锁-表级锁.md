---
date: 2025-04-09
tags:
  - MySQL进阶
---
MyISAM 和 InnoDB 支持表级锁。表级锁会锁住整张表。表级锁分为三类：
- 表锁
- 元数据锁
- 意向锁

# 表锁

表锁又划分为两类：
- 表共享读锁（read lock）
- 表独占写锁 （write lock）

## 表共享读锁`SHARED_READ_ONLY `

共享读锁的目的是**读一致性**。一张表的**表共享锁**允许被多个会话同时持有，表共享锁持有期间，阻塞任何会话获取写锁。

事务A 给某表加上表共享读锁后，未释放锁期间，该表仅支持 DQL 执行，事务 A 执行 DML 会报错。（同一事务内，共享锁和排他锁互斥。）其他事务执行 DML 则会阻塞等待。

![[attachments/Pasted image 20250409132713.png]]

## 表独占写锁`SHARED_NO_READ_WRITE

表独占写锁仅能被一个会话持有，仅该会话能够对该表进行读写操作，其他会话不能读写。表独占写锁被占有期间，请求锁的行为会被阻塞。

![[attachments/Pasted image 20250409140831.png]]

## 元数据锁 MDL

**系统自动控制**，避免 DML 和 DDL 冲突，保证表结构的一致性。
![[attachments/Pasted image 20250409142416.png]]

## 意向锁

InnoDB 同时支持**表级锁、行级锁**。意向锁用于提高**表级锁和行级锁冲突检测**效率。意向锁直接反映了行级锁有哪些类型，避免了添加表级锁时遍历整张表来检测是否有冲突的行级锁。

### 意向锁兼容性

**意向锁和表级锁兼容性**实际反映了行级锁和表级锁的兼容性，意向锁加快了冲突检测效率。意向锁之间相互兼容（IS 和 IS 、IS 和 IX、IX 和 IX 都兼容）；IS 和表级 S 锁兼容，和表级 IX 不兼容。IX 和任意表级锁都不兼容。

| 请求锁类型 \ 现有锁类型 | IS  | IX  | S   | X   |
| ------------- | --- | --- | --- | --- |
| IS            | 兼容  | 兼容  | 兼容  | 不兼容 |
| IX            | 兼容  | 兼容  | 不兼容 | 不兼容 |
| S             | 兼容  | 不兼容 | 兼容  | 不兼容 |
| X             | 不兼容 | 不兼容 | 不兼容 | 不兼容 |

## 意向锁设置时机

意向锁分为**意向共享锁 IS 和意向排他锁 IX**两种。当给某些行加**行共享锁或行排他锁**时，系统自动设置 IS 和 IX。

在 `REPEATABLE READ` 隔离级别下的意向锁设置行为：
1. 指定行级 S 锁时自动设置 IS 
```sql
SELECT ... LOCK IN SHARE MODE;  -- MySQL 8.0+
SELECT ... FOR SHARE;           -- MySQL 8.0 推荐语法
```

2. 指定行级 X 锁时自动设置 IX
```sql
SELECT ... FOR UPDATE;

UPDATE table SET ... WHERE ...;
DELETE FROM table WHERE ...;
INSERT INTO table ...;          -- 对聚簇索引加 X 锁
```