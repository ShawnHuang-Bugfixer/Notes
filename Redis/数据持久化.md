---
date: 2025-05-12
tags:
  - Redis数据持久化
---
Redis 数据存储在内存，Redis 服务故障后，数据可能丢失，因此 Redis 引入了 3 中持久化方式：

- `RDB` 持久化
- `AOF` 持久化
- `RDB` 和 `AOF` 混合持久化（`Redis v4.0` 以后）

# `RDB` 持久化

`RDB` (Redis Database Backup) Redis 数据备份是 Redis 在某时间节点的数据的备份（快照）

Redis 提供了两个命令来生成 `RDB` 快照文件：

- `save` : 同步保存操作，会阻塞 Redis 主线程；
- `bgsave` : fork 出一个子进程，子进程执行，不会阻塞 Redis 主线程，默认选项。

## `bgsave` 执行 `RDB` 持久化流程（基于 `copy-on-write` 技术）

![[attachments/Pasted image 20250512105445.png]]

1. 主进程 `fork` 出子进程，子进程包含了主进程此时刻的页表，页面指向了真实的物理内存。
2. 子进程根据页表查询物理内存并生成 `RDB` 文件，当操作完毕，将新的 `RDB` 文件替换旧的 `RDB` 文件
3. 子进程创建 `RDB` 文件过程中如果执行了数据写操作，会基于页表所指的物理内存拷贝创建副本，对该副本进行读写操作。（假设子进程创建 `RDB` 文件过程中主进程对所有数据都进行了写操作，在这种极端情况下，Redis 的数据量翻倍，内存占用翻倍）。

# `AOF` 持久化

`AOF` （Append Only File）持久化记录了 Redis 更改数据的命令，当 Redis 执行数据变更命令时，Redis 会将该文件添加到 `AOF` 文件中。

## `AOF` 持久化流程

开启 `AOF` 持久化后， 修改数据的命令都会追加到 `AOF` 缓冲区，等待持久化到磁盘，具体流程：

![[attachments/Pasted image 20250512110403.png]]

1. **命令追加**： Redis 执行了数据修改相关的命令，并将该命令增加到 `AOF` 缓冲区。
2. **写入内核缓冲区**：调用系统调用函数 `write()` 将 `AOF` 缓冲区数据写入系统内核缓冲区。
3. **刷入磁盘**：调用系统调用函数 `fsync()` 将内核缓冲区的数据持久化的磁盘中。
4. `AOF` **文件重写**：当 `AOF` 文件规超过配置的阈值，Redis 执行 `AOF` 文件重写，将指令合并，并压缩。
5. **加载 `AOF`**：Redis 服务重启后，加载 `AOF` 文件恢复数据。

## `AOF` 刷盘策略

Redis 的配置文件中存在三种不同的 `AOF` 持久化方式：

- `appendfsync always`：主线程调用 `write` 执行写操作后，后台线程（ `aof_fsync` 线程）立即会调用 `fsync` 函数同步 `AOF` 文件（刷盘），`fsync` 完成后线程返回，这样会严重降低 Redis 的性能（`write` + `fsync`）。
- `appendfsync everysec`：主线程调用 `write` 执行写操作后立即返回，由后台线程（ `aof_fsync` 线程）每秒钟调用 `fsync` 函数（系统调用）同步一次 `AOF` 文件（`write`+`fsync`，`fsync`间隔为 1 秒）
- `appendfsync no`：主线程调用 `write` 执行写操作后立即返回，让操作系统决定何时进行同步，Linux 下一般为 30 秒一次（`write`但不`fsync`，`fsync` 的时机由操作系统决定）。

## `AOF` 文件重写

`AOF` 文件记录了 Redis 数据修改指令，其体积容易扩大，因此 Redis 引入了 `AOF` 文件重写机制。执行重写时，Redis 会合并重复的指令，并压缩整个文件，最终替换旧的 `AOF` 文件。

当 `AOF`文件达到配置文件阈值或者执行命令 `bgwriteaof` 时，开始 `AOF` 文件重写。

`AOF` 文件重写流程（基于 `copy-on-write` 机制）：

1. 主进程 `fork` 出一个子进程，主进程继续处理命令。
2. 子进程根据页表扫描物理内存键值，构建命令序列。
3. 在子进程创建新 `AOF` 文件期间，主进程执行数据修改相关命令，主进程将这些命令**同时**写入 **`AOF` 缓冲区**和 **`AOF` 重写缓冲区**。
4. 子进程构建完毕命令序列后，将 **`AOF` 重写缓冲区**的命令追加到新 `AOF` 文件末尾。
5. 子进程将新的 `AOF` 文件替换旧的 `AOF` 文件。

# 混合持久化

`Redis v4.0` 引入混合持久化，`AOF` 文件包含 `RDB` 和 `AOF` 两个部分：

- **`RDB` 快照部分**：文件以固定的 `REDIS` 字符开头，存储某一时刻的内存数据快照，并在快照数据末尾附带一个 `CRC64` 校验和（位于 `RDB` 数据块尾部、`AOF` 增量部分之前）。
- **`AOF` 增量部分**：紧随 `RDB` 快照部分之后，记录 `RDB` 快照生成后的增量写命令。这部分增量命令以 Redis 协议格式逐条记录，无整体或全局校验和。

# `RDB` 和 `AOF` 对比

![[attachments/Pasted image 20250512115248.png]]