参考很多协同编辑文档，比如腾讯文档、金山文档，在 ChatGPT 辅助下设计了多用户在线协同编辑图片的服务。多个用户可以针对同一张图片在线协同编辑。

在线的协同编辑需要考虑到两个问题：多用户间如何通信？通信建立后，如何协同编辑图片？

## WebSocket 实时通信
考虑到一个用户的操作需要实时的展示给其他用户，即修改后的数据上传到服务端，服务端将这些改动数据分发给其他用户客户端，客户端根据修改后的数据渲染内容。数据流动是双向的，便使用 WebSocket 建立服务端到客户端的全双工通信通道。由于多用户需要对一张图片实时在线操作，因此需要维护图片 id 及其所有参与者的 WebSocketSession 映射 Map，便于将某个用户执行的动作通过该 Map 广播通知所有其他用户，其他用户客户端解析事件并执行对应渲染动作。

## 协同编辑
协同编辑图片时，将用户不同操作封装为不同事件，利用 WebSocket 将事件发送到服务端，服务端根据事件类型做不同处理。

由于是协同编辑，还需要解决协同冲突问题，如果允许多用户同时对图片进行协同编辑操作，那么多用户操作很可能前后冲突。针对文档协同冲突问题，现有解决方案包含操作转换（OT）、无冲突复制数据类型​和分区锁等方案。为了简化协同逻辑，参考第三种方案，利用 ConcurrentHashMap 存储图片 Id 和当前操作者的 Id 映射，仅允许同时存在一组映射关系，即同一时刻仅允许一个用户对图片进行编辑。

## Disruptor 优化事件驱动模型

第一版事件驱动模型采用同步模式，在 WebSocketHandler 处理器中解析事件，并执行广播动作。整个过程拖长了响应时长，当存在大量并发请求时，可能拖垮服务。

因此需要解耦接收事件和处理事件，有 Spring ApplicationEvent 和 Disruptor 两种方案。Spring ApplicationEvent 默认同步，改为异步需要额外配置且性能不如 Disruptor 故采用 Disruptor 解耦接收事件和处理事件。

利用 WebSocket 实现双向通信，并在处理器处发布事件后直接结束，由 Disruptor 事件消费者异步的执行事件消费逻辑。